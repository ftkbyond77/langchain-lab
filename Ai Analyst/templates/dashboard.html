
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraud Detection Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .metric { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .metric h3 { margin: 0; color: #667eea; }
        .metric p { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .btn { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #5a6fd8; }
        .chart-container { height: 400px; margin: 20px 0; }
        .ai-chat { background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .chat-input { width: 70%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .loading { display: none; color: #667eea; }
        .response { background: white; padding: 15px; border-radius: 5px; margin-top: 10px; white-space: pre-wrap; }
        .transaction-form { margin-top: 20px; }
        .transaction-form input, .transaction-form select { margin: 5px; padding: 8px; width: 200px; border: 1px solid #ddd; border-radius: 5px; }
        .agent-score {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .score-display {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
            line-height: 1.4;
        }
        .risk-high { background-color: #ffebee; border-left-color: #f44336; }
        .risk-medium { background-color: #fff3e0; border-left-color: #ff9800; }
        .risk-low { background-color: #e8f5e8; border-left-color: #4caf50; }
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Fraud Detection Analytics Dashboard</h1>
            <p>AI-Powered Financial Transaction Analysis</p>
        </div>
        
        <div class="metrics" id="metrics">
        </div>
        
        <div class="card">
            <h2>Data Visualizations</h2>
            <button class="btn" onclick="generateVisualizations()">Generate Visualizations</button>
            <div id="visualizations">
                <img id="fraud-analysis" src="/static/fraud_analysis.png" style="max-width: 100%; display: none;">
                <img id="correlation-heatmap" src="/static/correlation_heatmap.png" style="max-width: 100%; display: none;">
            </div>
        </div>
        
        <div class="card">
            <h2>AI Fraud Analyst</h2>
            <div class="ai-chat">
                <input type="text" class="chat-input" id="question" placeholder="Ask the AI analyst about fraud patterns...">
                <button class="btn" onclick="askAI()">Ask AI</button>
                <div class="loading" id="ai-loading">AI is analyzing...</div>
                <div class="response" id="ai-response"></div>
            </div>
        </div>
        
        <div class="card">
            <h2>Real-Time Transaction Scoring</h2>
            <div class="transaction-form">
                <h3>Simplified Transaction Analysis</h3>
                <p>Enter transaction type and account name for fraud risk assessment:</p>
                <select id="tx-type">
                    <option value="">Select Transaction Type</option>
                    <option value="TRANSFER">TRANSFER</option>
                    <option value="CASH_OUT">CASH_OUT</option>
                    <option value="DEBIT">DEBIT</option>
                    <option value="PAYMENT">PAYMENT</option>
                    <option value="CASH_IN">CASH_IN</option>
                </select>
                <input type="text" id="tx-nameOrig" placeholder="Account Name (e.g., M1979787155)">
                <button class="btn" onclick="scoreTransaction()">Score Transaction</button>
            </div>
            <div class="response" id="transaction-response"></div>
            
            <div class="card" style="margin-top: 20px; background: #fafafa;">
                <h3>Multi-Agent Analysis Results</h3>
                <div class="agent-grid" id="agent-scores">
                    <div class="agent-score">
                        <h4>Data Analyst Agent</h4>
                        <div id="analyst-score" class="score-display">Ready for analysis...</div>
                    </div>
                    <div class="agent-score">
                        <h4>Risk Scoring Agent</h4>
                        <div id="risk-score" class="score-display">Ready for scoring...</div>
                    </div>
                    <div class="agent-score">
                        <h4>Alert Generation Agent</h4>
                        <div id="alert-score" class="score-display">Ready for alerts...</div>
                    </div>
                    <div class="agent-score">
                        <h4>Recommendation Agent</h4>
                        <div id="recommendation-score" class="score-display">Ready for recommendations...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Machine Learning Models</h2>
            <button class="btn" onclick="buildModels()">Build Prediction Models</button>
            <div id="model-results"></div>
        </div>
        
        <div class="card">
            <h2>Generate Report</h2>
            <button class="btn" onclick="generateReport()">Generate PDF Report</button>
            <div id="report-status"></div>
            <a id="download-link" style="display: none;" class="btn" href="/download_report">Download Report</a>
        </div>
    </div>

    <script>
        loadMetrics();
        
        async function loadMetrics() {
            try {
                const response = await fetch('/api/data_overview');
                const data = await response.json();
                
                const metricsHtml = `
                    <div class="metric">
                        <h3>Total Transactions</h3>
                        <p>${data.total_transactions.toLocaleString()}</p>
                    </div>
                    <div class="metric">
                        <h3>Fraud Cases</h3>
                        <p>${data.fraud_cases.toLocaleString()}</p>
                    </div>
                    <div class="metric">
                        <h3>Fraud Rate</h3>
                        <p>${data.fraud_rate.toFixed(2)}%</p>
                    </div>
                    <div class="metric">
                        <h3>Transaction Types</h3>
                        <p>${Object.keys(data.transaction_types).length}</p>
                    </div>
                `;
                
                document.getElementById('metrics').innerHTML = metricsHtml;
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }
        
        async function generateVisualizations() {
            try {
                await fetch('/api/visualizations');
                document.getElementById('fraud-analysis').style.display = 'block';
                document.getElementById('correlation-heatmap').style.display = 'block';
                const timestamp = new Date().getTime();
                document.getElementById('fraud-analysis').src = `/static/fraud_analysis.png?t=${timestamp}`;
                document.getElementById('correlation-heatmap').src = `/static/correlation_heatmap.png?t=${timestamp}`;
            } catch (error) {
                console.error('Error generating visualizations:', error);
            }
        }
        
        async function askAI() {
            const question = document.getElementById('question').value;
            if (!question) return;
            
            document.getElementById('ai-loading').style.display = 'block';
            document.getElementById('ai-response').innerHTML = '';
            
            try {
                const response = await fetch('/api/ai_analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question })
                });
                
                const data = await response.json();
                let responseHtml = `<strong>Agent Response:</strong> ${data.agent_response || 'No response'}`;
                if (data.fraud_patterns) responseHtml += `<br><strong>Fraud Patterns:</strong> ${data.fraud_patterns}`;
                if (data.risk_score) responseHtml += `<br><strong>Risk Score:</strong> ${data.risk_score.toFixed(3)}`;
                if (data.alerts) responseHtml += `<br><strong>Alerts:</strong> ${data.alerts}`;
                if (data.recommendations) responseHtml += `<br><strong>Recommendations:</strong> ${data.recommendations}`;
                document.getElementById('ai-response').innerHTML = responseHtml;
            } catch (error) {
                document.getElementById('ai-response').innerHTML = 'Error: ' + error.message;
            }
            
            document.getElementById('ai-loading').style.display = 'none';
        }
        
        async function scoreTransaction() {
            const txType = document.getElementById('tx-type').value;
            const nameOrig = document.getElementById('tx-nameOrig').value;
            
            if (!txType || !nameOrig) {
                alert('Please fill in both Transaction Type and Account Name');
                return;
            }
            
            const transactionData = {
                type: txType,
                nameOrig: nameOrig
            };
            
            document.getElementById('transaction-response').innerHTML = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 5px;">
                    <h3>Analyzing Transaction...</h3>
                    <p>Processing: ${txType} transaction from ${nameOrig}</p>
                </div>
            `;
            
            document.getElementById('analyst-score').innerHTML = 'Analyzing historical patterns...';
            document.getElementById('risk-score').innerHTML = 'Calculating risk algorithms...';
            document.getElementById('alert-score').innerHTML = 'Generating security alerts...';
            document.getElementById('recommendation-score').innerHTML = 'Preparing recommendations...';
            
            const agentCards = document.querySelectorAll('.agent-score');
            agentCards.forEach(card => {
                card.className = 'agent-score';
            });
            
            try {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const response = await fetch('/api/score_transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transactionData)
                });
                
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('transaction-response').innerHTML = `
                        <div style="background: #ffebee; padding: 15px; border-radius: 5px; border-left: 4px solid #f44336;">
                            <h3>Error</h3>
                            <p>${data.error}</p>
                        </div>
                    `;
                    return;
                }
                
                const riskScore = data.risk_score;
                let riskLevel, riskColor, riskClass;
                
                if (riskScore > 0.7) {
                    riskLevel = 'HIGH RISK';
                    riskColor = '#ffebee';
                    riskClass = 'risk-high';
                } else if (riskScore > 0.4) {
                    riskLevel = 'MEDIUM RISK';
                    riskColor = '#fff3e0';
                    riskClass = 'risk-medium';
                } else {
                    riskLevel = 'LOW RISK';
                    riskColor = '#e8f5e8';
                    riskClass = 'risk-low';
                }
                
                document.getElementById('transaction-response').innerHTML = `
                    <div style="background: ${riskColor}; padding: 20px; border-radius: 10px; border-left: 4px solid ${riskScore > 0.7 ? '#f44336' : riskScore > 0.4 ? '#ff9800' : '#4caf50'};">
                        <h3>Transaction Analysis Complete</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                            <div>
                                <strong>Risk Score:</strong><br>
                                <span style="font-size: 24px; font-weight: bold;">${riskScore.toFixed(3)}</span> / 1.000
                            </div>
                            <div>
                                <strong>Risk Level:</strong><br>
                                <span style="font-size: 18px; font-weight: bold;">${riskLevel}</span>
                            </div>
                            <div>
                                <strong>Transaction:</strong><br>
                                ${txType} from ${nameOrig}
                            </div>
                            <div>
                                <strong>Confidence:</strong><br>
                                ${(riskScore * 100).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('analyst-score').innerHTML = `
ANALYSIS COMPLETE

Transaction Details:
Type: ${txType}
Account: ${nameOrig}
Pattern Match: ${txType === 'TRANSFER' || txType === 'CASH_OUT' ? 'High-Risk Pattern' : 'Standard Pattern'}

Historical Context:
${txType} transactions: ${txType === 'TRANSFER' ? '70% fraud risk' : txType === 'CASH_OUT' ? '80% fraud risk' : 'Lower risk profile'}
Account pattern: ${nameOrig.length <= 3 ? 'Suspicious (very short)' : 'Standard format'}
Risk category: ${riskLevel}

Status: Pattern analysis completed
                `;
                
                document.getElementById('risk-score').innerHTML = `
RISK CALCULATION COMPLETE

Risk Score: ${riskScore.toFixed(3)} / 1.000
Confidence Level: ${(riskScore * 100).toFixed(1)}%

Risk Components:
Transaction Type Risk: ${riskScore > 0.6 ? 'High' : riskScore > 0.3 ? 'Medium' : 'Low'}
Account Name Risk: ${nameOrig.length <= 3 ? 'High' : 'Standard'}
Pattern Matching: ${data.detailed_factors ? 'Multiple factors' : 'Standard analysis'}

Model Status: Active and operational
Threshold Status: ${riskScore > 0.7 ? 'EXCEEDS HIGH THRESHOLD' : riskScore > 0.4 ? 'Exceeds medium threshold' : 'Below risk thresholds'}
                `;
                
                document.getElementById('alert-score').innerHTML = data.alerts || `
ALERT GENERATION COMPLETE

Alert Level: ${riskLevel}
Priority: ${riskScore > 0.7 ? 'IMMEDIATE ATTENTION' : riskScore > 0.4 ? 'Enhanced monitoring' : 'Standard processing'}

Generated Alerts:
${riskScore > 0.7 ? 'HIGH RISK: Manual review required
INVESTIGATE: Account activity patterns
ESCALATE: To fraud investigation team' : 
  riskScore > 0.4 ? 'MEDIUM RISK: Additional verification needed
LOG: Transaction for pattern analysis
MONITOR: Account for unusual activity' :
  'LOW RISK: Standard processing approved
ROUTINE: Continue normal monitoring
CLEARED: No additional action required'}

Status: Alert protocols activated
                `;
                
                document.getElementById('recommendation-score').innerHTML = data.recommendations || `
RECOMMENDATIONS GENERATED

Risk Level: ${riskLevel} (${riskScore.toFixed(3)})

Immediate Actions:
${riskScore > 0.7 ? 
    'BLOCK: Consider blocking transaction
REVIEW: Require manual approval
INVESTIGATE: Full account audit
CONTACT: Verify with account holder' :
    riskScore > 0.4 ?
    'VERIFY: Apply additional authentication
MONITOR: Enhanced transaction monitoring
LOG: Record for pattern analysis
DELAY: Consider brief verification delay' :
    'APPROVE: Standard processing approved
MONITOR: Continue routine monitoring
LOG: Standard transaction logging
PROCESS: No additional steps needed'
}

Prevention Measures:
Update risk thresholds based on this analysis
Monitor similar transaction patterns
Review account ${nameOrig} activity history
${riskScore > 0.5 ? 'Implement enhanced controls' : 'Maintain current security protocols'}

Status: Recommendations ready for implementation
                `;
                
                agentCards.forEach(card => {
                    card.className = `agent-score ${riskClass}`;
                });
                
                const responseElement = document.getElementById('transaction-response');
                responseElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
            } catch (error) {
                document.getElementById('transaction-response').innerHTML = `
                    <div style="background: #ffebee; padding: 15px; border-radius: 5px; border-left: 4px solid #f44336;">
                        <h3>System Error</h3>
                        <p>Error analyzing transaction: ${error.message}</p>
                        <p>Please try again or contact system administrator.</p>
                    </div>
                `;
                
                document.getElementById('analyst-score').innerHTML = 'Analysis failed - please retry';
                document.getElementById('risk-score').innerHTML = 'Risk calculation failed - please retry';
                document.getElementById('alert-score').innerHTML = 'Alert generation failed - please retry';
                document.getElementById('recommendation-score').innerHTML = 'Recommendation generation failed - please retry';
            }
        }
        
        async function buildModels() {
            document.getElementById('model-results').innerHTML = 'Building machine learning models...';
            
            try {
                const response = await fetch('/api/predict_model');
                const data = await response.json();
                
                let resultsHtml = '<h3>Model Performance Results:</h3>';
                for (const [modelName, metrics] of Object.entries(data)) {
                    const auc = metrics.auc_score;
                    const performance = auc > 0.9 ? 'Excellent' : auc > 0.8 ? 'Good' : auc > 0.7 ? 'Fair' : 'Poor';
                    const color = auc > 0.9 ? '#4caf50' : auc > 0.8 ? '#8bc34a' : auc > 0.7 ? '#ff9800' : '#f44336';
                    
                    resultsHtml += `
                        <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid ${color};">
                            <h4>${modelName} - ${performance}</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                <div><strong>AUC Score:</strong> ${metrics.auc_score.toFixed(3)}</div>
                                <div><strong>Precision:</strong> ${metrics.classification_report['weighted avg']['precision'].toFixed(3)}</div>
                                <div><strong>Recall:</strong> ${metrics.classification_report['weighted avg']['recall'].toFixed(3)}</div>
                                <div><strong>F1-Score:</strong> ${metrics.classification_report['weighted avg']['f1-score'].toFixed(3)}</div>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('model-results').innerHTML = resultsHtml;
            } catch (error) {
                document.getElementById('model-results').innerHTML = 'Error building models: ' + error.message;
            }
        }
        
        async function generateReport() {
            document.getElementById('report-status').innerHTML = 'Generating comprehensive PDF report...';
            
            try {
                const response = await fetch('/api/generate_report');
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('report-status').innerHTML = 'Report generated successfully!';
                    document.getElementById('download-link').style.display = 'inline-block';
                } else {
                    document.getElementById('report-status').innerHTML = 'Error generating report.';
                }
            } catch (error) {
                document.getElementById('report-status').innerHTML = 'Error generating report: ' + error.message;
            }
        }
        
        document.getElementById('question').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                askAI();
            }
        });
        
        document.getElementById('tx-nameOrig').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                scoreTransaction();
            }
        });
        
        document.getElementById('tx-type').addEventListener('change', function() {
            if (this.value) {
                this.style.borderColor = '#4caf50';
            }
        });
        
        document.getElementById('tx-nameOrig').addEventListener('input', function() {
            if (this.value.length > 0) {
                this.style.borderColor = '#4caf50';
            } else {
                this.style.borderColor = '#ddd';
            }
        });
    </script>
</body>
</html>
